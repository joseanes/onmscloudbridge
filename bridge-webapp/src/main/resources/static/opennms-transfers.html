<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenNMS Transfers - Cloud Bridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .header {
            background-color: #1976D2;
            color: white;
            padding: 15px 0;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: inline-block;
            margin-right: 5px;
        }
        .status-running {
            background-color: #FFC107;
            color: #000;
        }
        .status-completed {
            background-color: #4CAF50;
            color: white;
        }
        .status-failed {
            background-color: #F44336;
            color: white;
        }
        .card-header {
            background-color: #E3F2FD;
            border-bottom: 1px solid #BBDEFB;
        }
        .modal-body pre {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
        #transfersTable tbody tr {
            cursor: pointer;
        }
        #transfersTable tbody tr:hover {
            background-color: #f0f8ff;
        }
        .card-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .node-metrics-tabs {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1>OpenNMS Cloud Bridge</h1>
                <div>
                    <a href="index.html" class="btn btn-outline-light">Dashboard</a>
                    <a href="opennms-transfers.html" class="btn btn-light">OpenNMS Transfers</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3>OpenNMS Connection</h3>
                    </div>
                    <div class="card-body">
                        <div id="connectionStatus" class="alert alert-info">
                            Checking connection status...
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="baseUrl" class="form-label">OpenNMS Base URL</label>
                                    <input type="text" class="form-control" id="baseUrl" value="" disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" value="" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button id="testConnectionBtn" class="btn btn-primary me-md-2">Test Connection</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <ul class="nav nav-tabs node-metrics-tabs" id="transferTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-content" type="button" role="tab" aria-controls="nodes-content" aria-selected="true">Nodes</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics-content" type="button" role="tab" aria-controls="metrics-content" aria-selected="false">Metrics</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-content" type="button" role="tab" aria-controls="history-content" aria-selected="false">Transfer History</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="transferTabsContent">
                    <!-- Nodes Tab -->
                    <div class="tab-pane fade show active" id="nodes-content" role="tabpanel" aria-labelledby="nodes-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3>Create/Update Nodes in OpenNMS</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-toolbar">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autosyncNodes">
                                        <label class="form-check-label" for="autosyncNodes">
                                            Auto-sync nodes on discovery
                                        </label>
                                    </div>
                                    <div>
                                        <button id="refreshResourcesBtn" class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh Resources
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="resourcesTable">
                                        <thead>
                                            <tr>
                                                <th>Provider</th>
                                                <th>Resource ID</th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Region</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Resources will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="resourcesMessage" class="alert alert-info">
                                    Loading resources...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Tab -->
                    <div class="tab-pane fade" id="metrics-content" role="tabpanel" aria-labelledby="metrics-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3>Send Metrics to OpenNMS</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-toolbar">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autosyncMetrics">
                                        <label class="form-check-label" for="autosyncMetrics">
                                            Auto-sync metrics on collection
                                        </label>
                                    </div>
                                    <div class="d-flex gap-3 align-items-center">
                                        <div class="input-group" style="width: 300px;">
                                            <span class="input-group-text">Sync Interval</span>
                                            <input type="number" class="form-control" id="syncInterval" min="5" value="15" disabled>
                                            <span class="input-group-text">minutes</span>
                                        </div>
                                        <button id="syncNowBtn" class="btn btn-primary">Sync Now</button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="metricsResourcesTable">
                                        <thead>
                                            <tr>
                                                <th>Provider</th>
                                                <th>Resource ID</th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Region</th>
                                                <th>Last Collection</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Resources for metrics will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="metricsResourcesMessage" class="alert alert-info">
                                    Loading resources...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- History Tab -->
                    <div class="tab-pane fade" id="history-content" role="tabpanel" aria-labelledby="history-tab">
                        <div class="card">
                            <div class="card-header">
                                <h3>Transfer Job History</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="transfersTable">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Provider</th>
                                                <th>Resource</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Start Time</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Transfer jobs will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="transfersMessage" class="alert alert-info">
                                    Loading transfer history...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobDetailsModalLabel">Transfer Job Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <dl class="row">
                                        <dt class="col-sm-4">Job ID:</dt>
                                        <dd class="col-sm-8" id="modalJobId"></dd>
                                        
                                        <dt class="col-sm-4">Provider:</dt>
                                        <dd class="col-sm-8" id="modalProvider"></dd>
                                        
                                        <dt class="col-sm-4">Resource ID:</dt>
                                        <dd class="col-sm-8" id="modalResourceId"></dd>
                                        
                                        <dt class="col-sm-4">Type:</dt>
                                        <dd class="col-sm-8" id="modalType"></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Status Information</h6>
                                </div>
                                <div class="card-body">
                                    <dl class="row">
                                        <dt class="col-sm-4">Status:</dt>
                                        <dd class="col-sm-8" id="modalStatus"></dd>
                                        
                                        <dt class="col-sm-4">Start Time:</dt>
                                        <dd class="col-sm-8" id="modalStartTime"></dd>
                                        
                                        <dt class="col-sm-4">End Time:</dt>
                                        <dd class="col-sm-8" id="modalEndTime"></dd>
                                        
                                        <dt class="col-sm-4">Duration:</dt>
                                        <dd class="col-sm-8" id="modalDuration"></dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Message</h6>
                                </div>
                                <div class="card-body">
                                    <p id="modalMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3" id="modalMetricsRow">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Metrics Information</h6>
                                </div>
                                <div class="card-body">
                                    <p>Total metrics: <span id="modalMetricCount">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let resources = [];
        let transferJobs = [];
        let connectionInfo = null;
        
        // Utility functions
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        function formatDuration(startIso, endIso) {
            if (!startIso || !endIso) return '-';
            
            const start = new Date(startIso);
            const end = new Date(endIso);
            const diffMs = end - start;
            const diffSec = Math.floor(diffMs / 1000);
            
            if (diffSec < 60) {
                return `${diffSec} sec`;
            } else if (diffSec < 3600) {
                const min = Math.floor(diffSec / 60);
                const sec = diffSec % 60;
                return `${min} min ${sec} sec`;
            } else {
                const hrs = Math.floor(diffSec / 3600);
                const min = Math.floor((diffSec % 3600) / 60);
                return `${hrs} hr ${min} min`;
            }
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'RUNNING': return 'status-badge status-running';
                case 'COMPLETED': return 'status-badge status-completed';
                case 'FAILED': return 'status-badge status-failed';
                default: return 'status-badge';
            }
        }
        
        // API functions
        async function fetchOpenNMSConnectionInfo() {
            try {
                const response = await fetch('/bridge/api/opennms/connection');
                if (!response.ok) {
                    throw new Error(`Failed to fetch connection info: ${response.status}`);
                }
                
                connectionInfo = await response.json();
                
                // Update UI
                document.getElementById('baseUrl').value = connectionInfo.baseUrl || '';
                document.getElementById('username').value = connectionInfo.username || '';
                
                updateConnectionStatusUI(connectionInfo.connectionStatus);
                
                return connectionInfo;
            } catch (error) {
                console.error('Error fetching connection info:', error);
                updateConnectionStatusUI(false);
                return null;
            }
        }
        
        async function testOpenNMSConnection() {
            try {
                document.getElementById('connectionStatus').innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing connection...';
                
                const response = await fetch('/bridge/api/opennms/test-connection');
                if (!response.ok) {
                    throw new Error(`Failed to test connection: ${response.status}`);
                }
                
                const result = await response.json();
                updateConnectionStatusUI(result.success, result.message);
                return result.success;
            } catch (error) {
                console.error('Error testing connection:', error);
                updateConnectionStatusUI(false, 'Error testing connection: ' + error.message);
                return false;
            }
        }
        
        async function fetchResources() {
            try {
                document.getElementById('resourcesMessage').textContent = 'Loading resources...';
                document.getElementById('metricsResourcesMessage').textContent = 'Loading resources...';
                
                // Fetch all providers
                const providersResponse = await fetch('/bridge/api/cloud-providers');
                if (!providersResponse.ok) {
                    throw new Error(`Failed to fetch providers: ${providersResponse.status}`);
                }
                
                const providers = await providersResponse.json();
                
                // Collect all resources from all providers
                resources = [];
                
                for (const provider of providers) {
                    const resourcesResponse = await fetch(`/bridge/api/discovery/resources?providerId=${provider.id}`);
                    if (!resourcesResponse.ok) {
                        console.warn(`Failed to fetch resources for provider ${provider.id}`);
                        continue;
                    }
                    
                    const providerResources = await resourcesResponse.json();
                    if (providerResources && providerResources.resources) {
                        // Add provider name to each resource
                        providerResources.resources.forEach(resource => {
                            resource.providerName = provider.name;
                            resources.push(resource);
                        });
                    }
                }
                
                // Update UI
                updateResourcesTables();
                
                document.getElementById('resourcesMessage').style.display = 'none';
                document.getElementById('metricsResourcesMessage').style.display = 'none';
                
                return resources;
            } catch (error) {
                console.error('Error fetching resources:', error);
                document.getElementById('resourcesMessage').textContent = 'Error loading resources: ' + error.message;
                document.getElementById('resourcesMessage').classList.replace('alert-info', 'alert-danger');
                document.getElementById('metricsResourcesMessage').textContent = 'Error loading resources: ' + error.message;
                document.getElementById('metricsResourcesMessage').classList.replace('alert-info', 'alert-danger');
                return [];
            }
        }
        
        async function fetchTransferJobs() {
            try {
                document.getElementById('transfersMessage').textContent = 'Loading transfer history...';
                
                const response = await fetch('/bridge/api/opennms/transfers');
                if (!response.ok) {
                    throw new Error(`Failed to fetch transfer jobs: ${response.status}`);
                }
                
                const result = await response.json();
                transferJobs = result.jobs || [];
                
                // Update UI
                updateTransfersTable();
                
                document.getElementById('transfersMessage').style.display = 'none';
                
                return transferJobs;
            } catch (error) {
                console.error('Error fetching transfer jobs:', error);
                document.getElementById('transfersMessage').textContent = 'Error loading transfer history: ' + error.message;
                document.getElementById('transfersMessage').classList.replace('alert-info', 'alert-danger');
                return [];
            }
        }
        
        async function createNodeInOpenNMS(providerId, resourceId) {
            try {
                const response = await fetch('/bridge/api/opennms/nodes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        providerId,
                        resourceId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to create node: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully started node creation job (${result.jobId})`);
                    // Refresh transfer jobs after a brief delay
                    setTimeout(fetchTransferJobs, 1000);
                } else {
                    alert(`Failed to create node: ${result.message}`);
                }
                
                return result;
            } catch (error) {
                console.error('Error creating node:', error);
                alert('Error creating node: ' + error.message);
                return null;
            }
        }
        
        async function sendMetricsToOpenNMS(providerId, resourceId) {
            try {
                const response = await fetch('/bridge/api/opennms/metrics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        providerId,
                        resourceId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to send metrics: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully started metrics collection job (${result.jobId})`);
                    // Refresh transfer jobs after a brief delay
                    setTimeout(fetchTransferJobs, 1000);
                } else {
                    alert(`Failed to send metrics: ${result.message}`);
                }
                
                return result;
            } catch (error) {
                console.error('Error sending metrics:', error);
                alert('Error sending metrics: ' + error.message);
                return null;
            }
        }
        
        async function fetchJobDetails(jobId) {
            try {
                const response = await fetch(`/bridge/api/opennms/transfers/${jobId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch job details: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error fetching job details for ${jobId}:`, error);
                return null;
            }
        }
        
        // UI update functions
        function updateConnectionStatusUI(isConnected, message) {
            const statusEl = document.getElementById('connectionStatus');
            
            if (isConnected) {
                statusEl.className = 'alert alert-success';
                statusEl.innerHTML = '<strong>Connected to OpenNMS</strong>' + (message ? `: ${message}` : '');
            } else {
                statusEl.className = 'alert alert-warning';
                statusEl.innerHTML = '<strong>Not connected to OpenNMS</strong>' + (message ? `: ${message}` : '');
            }
        }
        
        function updateResourcesTables() {
            // Update resources table
            const resourcesTableBody = document.getElementById('resourcesTable').querySelector('tbody');
            resourcesTableBody.innerHTML = '';
            
            const metricsResourcesTableBody = document.getElementById('metricsResourcesTable').querySelector('tbody');
            metricsResourcesTableBody.innerHTML = '';
            
            if (resources.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="6" class="text-center">No resources found</td>';
                resourcesTableBody.appendChild(emptyRow);
                
                const emptyMetricsRow = document.createElement('tr');
                emptyMetricsRow.innerHTML = '<td colspan="7" class="text-center">No resources found</td>';
                metricsResourcesTableBody.appendChild(emptyMetricsRow);
                return;
            }
            
            resources.forEach(resource => {
                // Create row for resources table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${resource.providerName || resource.providerId}</td>
                    <td>${resource.resourceId}</td>
                    <td>${resource.name || '-'}</td>
                    <td>${resource.resourceType || '-'}</td>
                    <td>${resource.region || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm create-node-btn" 
                                data-provider-id="${resource.providerId}" 
                                data-resource-id="${resource.resourceId}">
                            Send to OpenNMS
                        </button>
                    </td>
                `;
                resourcesTableBody.appendChild(row);
                
                // Create row for metrics table
                const metricsRow = document.createElement('tr');
                metricsRow.innerHTML = `
                    <td>${resource.providerName || resource.providerId}</td>
                    <td>${resource.resourceId}</td>
                    <td>${resource.name || '-'}</td>
                    <td>${resource.resourceType || '-'}</td>
                    <td>${resource.region || '-'}</td>
                    <td>${resource.lastCollection ? formatDateTime(resource.lastCollection) : 'Never'}</td>
                    <td>
                        <button class="btn btn-primary btn-sm send-metrics-btn" 
                                data-provider-id="${resource.providerId}" 
                                data-resource-id="${resource.resourceId}">
                            Send Metrics
                        </button>
                    </td>
                `;
                metricsResourcesTableBody.appendChild(metricsRow);
            });
            
            // Add event listeners for node creation buttons
            document.querySelectorAll('.create-node-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const providerId = this.getAttribute('data-provider-id');
                    const resourceId = this.getAttribute('data-resource-id');
                    await createNodeInOpenNMS(providerId, resourceId);
                });
            });
            
            // Add event listeners for metrics buttons
            document.querySelectorAll('.send-metrics-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const providerId = this.getAttribute('data-provider-id');
                    const resourceId = this.getAttribute('data-resource-id');
                    await sendMetricsToOpenNMS(providerId, resourceId);
                });
            });
        }
        
        function updateTransfersTable() {
            const tableBody = document.getElementById('transfersTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            if (transferJobs.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="7" class="text-center">No transfer jobs found</td>';
                tableBody.appendChild(emptyRow);
                return;
            }
            
            transferJobs.forEach(job => {
                const row = document.createElement('tr');
                row.setAttribute('data-job-id', job.jobId);
                row.innerHTML = `
                    <td>${job.jobId.substring(0, 8)}...</td>
                    <td>${job.providerId}</td>
                    <td>${job.resourceId}</td>
                    <td>${job.type}</td>
                    <td><span class="${getStatusBadgeClass(job.status)}">${job.status}</span></td>
                    <td>${formatDateTime(job.startTime)}</td>
                    <td>${job.endTime ? formatDuration(job.startTime, job.endTime) : 'In Progress'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners for row clicks
            document.querySelectorAll('#transfersTable tbody tr').forEach(row => {
                row.addEventListener('click', async function() {
                    const jobId = this.getAttribute('data-job-id');
                    const jobDetails = await fetchJobDetails(jobId);
                    if (jobDetails) {
                        showJobDetailsModal(jobDetails);
                    }
                });
            });
        }
        
        function showJobDetailsModal(job) {
            // Set basic info
            document.getElementById('modalJobId').textContent = job.jobId;
            document.getElementById('modalProvider').textContent = job.providerId;
            document.getElementById('modalResourceId').textContent = job.resourceId;
            document.getElementById('modalType').textContent = job.type;
            
            // Set status info
            const statusEl = document.getElementById('modalStatus');
            statusEl.textContent = job.status;
            statusEl.className = getStatusBadgeClass(job.status);
            
            document.getElementById('modalStartTime').textContent = formatDateTime(job.startTime);
            document.getElementById('modalEndTime').textContent = job.endTime ? formatDateTime(job.endTime) : '-';
            document.getElementById('modalDuration').textContent = job.endTime ? formatDuration(job.startTime, job.endTime) : 'In Progress';
            
            // Set message
            document.getElementById('modalMessage').textContent = job.message || 'No message';
            
            // Set metrics info if available
            const metricsRow = document.getElementById('modalMetricsRow');
            if (job.type === 'METRICS' && job.metricCount !== undefined) {
                document.getElementById('modalMetricCount').textContent = job.metricCount;
                metricsRow.style.display = 'block';
            } else {
                metricsRow.style.display = 'none';
            }
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
        }
        
        // Event listeners
        document.getElementById('testConnectionBtn').addEventListener('click', testOpenNMSConnection);
        
        document.getElementById('refreshResourcesBtn').addEventListener('click', fetchResources);
        
        document.getElementById('syncNowBtn').addEventListener('click', async function() {
            try {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...';
                
                const response = await fetch('/bridge/api/opennms/sync/metrics/sync-now', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to trigger sync: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Synchronization started successfully');
                    // Refresh transfer jobs after a brief delay
                    setTimeout(fetchTransferJobs, 2000);
                }
            } catch (error) {
                console.error('Error triggering sync:', error);
                alert('Error triggering sync: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = 'Sync Now';
            }
        });
        
        document.getElementById('autosyncMetrics').addEventListener('change', function() {
            const isChecked = this.checked;
            document.getElementById('syncInterval').disabled = !isChecked;
            
            // Update the auto-sync setting
            updateMetricsSyncSettings({
                enabled: isChecked
            });
        });
        
        document.getElementById('autosyncNodes').addEventListener('change', function() {
            const isChecked = this.checked;
            
            // Update the auto-sync setting
            updateNodeSyncSettings({
                enabled: isChecked
            });
        });
        
        document.getElementById('syncInterval').addEventListener('change', function() {
            const interval = parseInt(this.value);
            if (isNaN(interval) || interval < 1) {
                this.value = 15; // Reset to default
                return;
            }
            
            // Update the interval setting
            updateMetricsSyncSettings({
                interval: interval
            });
        });
        
        /**
         * Update node synchronization settings
         */
        async function updateNodeSyncSettings(settings) {
            try {
                const response = await fetch('/bridge/api/opennms/sync/nodes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update node sync settings: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    console.error('Error updating node sync settings:', result.error);
                    alert('Error updating node sync settings: ' + result.error);
                } else {
                    console.log('Node sync settings updated:', result);
                }
                
                return result;
            } catch (error) {
                console.error('Error updating node sync settings:', error);
                alert('Error updating node sync settings: ' + error.message);
                return null;
            }
        }
        
        /**
         * Update metrics synchronization settings
         */
        async function updateMetricsSyncSettings(settings) {
            try {
                const response = await fetch('/bridge/api/opennms/sync/metrics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update metrics sync settings: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    console.error('Error updating metrics sync settings:', result.error);
                    alert('Error updating metrics sync settings: ' + result.error);
                } else {
                    console.log('Metrics sync settings updated:', result);
                }
                
                return result;
            } catch (error) {
                console.error('Error updating metrics sync settings:', error);
                alert('Error updating metrics sync settings: ' + error.message);
                return null;
            }
        }
        
        /**
         * Fetch synchronization settings
         */
        async function fetchSyncSettings() {
            try {
                const response = await fetch('/bridge/api/opennms/sync/settings');
                if (!response.ok) {
                    throw new Error(`Failed to fetch sync settings: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Update UI with settings
                document.getElementById('autosyncNodes').checked = result.autoSyncNodes === true;
                document.getElementById('autosyncMetrics').checked = result.autoSyncMetrics === true;
                
                if (result.syncIntervalMinutes) {
                    document.getElementById('syncInterval').value = result.syncIntervalMinutes;
                }
                
                document.getElementById('syncInterval').disabled = !result.autoSyncMetrics;
                
                return result;
            } catch (error) {
                console.error('Error fetching sync settings:', error);
                return null;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await fetchOpenNMSConnectionInfo();
            await fetchResources();
            await fetchTransferJobs();
            await fetchSyncSettings();
            
            // Set up refresh interval for transfer jobs
            setInterval(fetchTransferJobs, 10000); // Refresh every 10 seconds
        });
    </script>
</body>
</html>